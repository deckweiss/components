<script lang="ts">
	import { Button } from "$lib/components/ui/button";
	import DataTable from "$lib/registry/blocks/data-table/data-table.svelte";
	import type { ColumnDef, Row } from "@tanstack/table-core";
	import { createRawSnippet } from "svelte";
	import { renderSnippet } from "$lib/components/ui/data-table";
	import { buttonVariants } from "$lib/registry/ui/button";
	import * as DropdownMenu from "$lib/components/ui/dropdown-menu";
	import { dataTableData, type Payment } from "./sample-data";
	import Input from "$lib/components/ui/input/input.svelte";
	import { Ellipsis } from "@lucide/svelte";
	import * as Dialog from "$lib/components/ui/dialog";
	import PlusIcon from "@lucide/svelte/icons/plus";

	let locale = $state("de");
	let statusHeader = $derived(locale === "de" ? "Status" : "Status");
	let emailHeader = $derived(locale === "de" ? "E-Mail" : "Email");
	let amountHeader = $derived(locale === "de" ? "Betrag" : "Amount");
	let startDateHeader = $derived(locale === "de" ? "Startdatum" : "Start Date");
	let endDateHeader = $derived(locale === "de" ? "Enddatum" : "End Date");
	let isActiveHeader = $derived(locale === "de" ? "Aktiv" : "Active");
	let categoryHeader = $derived(locale === "de" ? "Kategorie" : "Category");
	let actionsHeader = $derived(locale === "de" ? "Aktionen" : "Actions");
	let insertDialogOpen = $state(false);

	const columns: ColumnDef<Payment>[] = [
		{
			accessorKey: "status",
			header: () => statusHeader,
			cell: ({ row }) => {
				const statusSnippet = createRawSnippet<[string]>((getStatus) => {
					const status = getStatus();
					return {
						render: () => `<div class="capitalize">${status}</div>`,
					};
				});
				return renderSnippet(statusSnippet, row.getValue("status"));
			},
			enableColumnFilter: true,
			enableHiding: true,
			minSize: 50,
			size: 100,
			maxSize: 200,
			meta: {
				sticky: "left",
			},
		},
		{
			accessorKey: "email",
			header: () => emailHeader,
			cell: ({ row }) => {
				const emailSnippet = createRawSnippet<[string]>((getEmail) => {
					const email = getEmail();
					return {
						render: () => `<div class="lowercase">${email}</div>`,
					};
				});

				return renderSnippet(emailSnippet, row.getValue("email"));
			},
			enableColumnFilter: true,
			enableSorting: true,
			enableHiding: true,
			minSize: 100,
			size: 200,
			maxSize: 300,
		},
		{
			id: "amount",
			accessorKey: "amount",
			header: () => amountHeader,
			cell: ({ row }) => {
				const amountCellSnippet = createRawSnippet<[string]>((getAmount) => {
					const amount = getAmount();
					return {
						render: () => `<div class="text-right font-medium">${amount}</div>`,
					};
				});
				const formatter = new Intl.NumberFormat("en-US", {
					style: "currency",
					currency: "USD",
				});

				return renderSnippet(
					amountCellSnippet,
					formatter.format(Number.parseFloat(row.getValue("amount")))
				);
			},
			enableSorting: true,
			minSize: 100,
			size: 150,
			maxSize: 200,
		},
		{
			accessorKey: "startDate",
			header: () => startDateHeader,
			cell: ({ row }) => {
				const dateSnippet = createRawSnippet<[string]>((getDate) => {
					const date = getDate();
					return {
						render: () => `<div>${date}</div>`,
					};
				});
				const dateValue = row.getValue("startDate") as string;
				const formattedDate = new Date(dateValue).toLocaleDateString("de-DE", {
					year: "numeric",
					month: "2-digit",
					day: "2-digit",
				});

				return renderSnippet(dateSnippet, formattedDate);
			},
			enableColumnFilter: true,
			enableSorting: true,
			enableHiding: true,
			minSize: 150,
			size: 200,
			maxSize: 300,
		},
		{
			accessorKey: "endDate",
			header: () => endDateHeader,
			cell: ({ row }) => {
				const dateSnippet = createRawSnippet<[string]>((getDate) => {
					const date = getDate();
					return {
						render: () => `<div>${date}</div>`,
					};
				});
				const dateValue = row.getValue("endDate") as string;
				const formattedDate = new Date(dateValue).toLocaleDateString("de-DE", {
					year: "numeric",
					month: "2-digit",
					day: "2-digit",
				});

				return renderSnippet(dateSnippet, formattedDate);
			},
			enableColumnFilter: true,
			enableSorting: true,
			enableHiding: true,
			minSize: 150,
			size: 200,
			maxSize: 300,
		},
		{
			accessorKey: "isActive",
			header: () => isActiveHeader,
			cell: ({ row }) => {
				const boolSnippet = createRawSnippet<[boolean]>((getBool) => {
					const value = getBool();
					return {
						render: () => `<div class="text-center">${value ? "✓" : "✗"}</div>`,
					};
				});
				return renderSnippet(boolSnippet, row.getValue("isActive") as boolean);
			},
			enableColumnFilter: true,
			enableSorting: true,
			enableHiding: true,
			minSize: 80,
			size: 100,
			maxSize: 120,
		},
		{
			accessorKey: "category",
			header: () => categoryHeader,
			cell: ({ row }) => {
				const categorySnippet = createRawSnippet<[string]>((getCategory) => {
					const category = getCategory();
					return {
						render: () => `<div>${category}</div>`,
					};
				});
				return renderSnippet(categorySnippet, row.getValue("category") as string);
			},
			enableColumnFilter: true,
			enableSorting: true,
			enableHiding: true,
			minSize: 100,
			size: 150,
			maxSize: 200,
		},
		{
			id: "actions",
			enableHiding: false,
			header: () => actionsHeader,
			cell: ({ row }) => renderSnippet(dataTableActions, row),
			minSize: 100,
			size: 150,
			maxSize: 300,
		},
	];
</script>

<div class="space-y-4">
	<Button onclick={() => (locale = locale === "de" ? "en" : "de")} variant="outline">
		Set locale to {locale === "de" ? "en" : "de"}
	</Button>
	<DataTable
		{columns}
		data={dataTableData}
		enableExpanding
		enablePagination
		enableRowSelection
		onRowClick={(row) => row.toggleExpanded()}
		enableResizing
	>
		{#snippet insertButton(table)}
			<Dialog.Root bind:open={insertDialogOpen}>
				<Button
					variant="default"
					size="sm"
					class="h-8"
					onclick={() => (insertDialogOpen = true)}
				>
					<PlusIcon class="size-4" />
					<span class="hidden md:inline">Neu</span>
				</Button>
				<Dialog.Content>
					<Dialog.Header>
						<Dialog.Title>Anpassbarer Button</Dialog.Title>
						<Dialog.Description>
							Dieser Button kann vollständig angepasst werden. Sie können hier Ihre
							eigene Logik implementieren.
						</Dialog.Description>
					</Dialog.Header>
					<div class="py-4">
						<p class="text-muted-foreground text-sm">
							Der Button und seine Aktion können über das <code
								class="bg-muted rounded px-1 py-0.5 text-xs">insertButton</code
							> Snippet vollständig angepasst werden.
						</p>
					</div>
					<Dialog.Footer>
						<Button variant="outline" onclick={() => (insertDialogOpen = false)}
							>Schließen</Button
						>
					</Dialog.Footer>
				</Dialog.Content>
			</Dialog.Root>
		{/snippet}
		{#snippet expandedRow(row)}
			<pre class="text-xs">{JSON.stringify(row.original, null, 2)}</pre>
		{/snippet}

		{#snippet customFilters(table)}
			<div class="bg-muted px-2 py-2">
				<Input
					placeholder="E-Mail"
					oninput={(event) => {
						const text = event.target.value;
						table.getColumn("email")?.setFilterValue(text);
					}}
				/>
			</div>
		{/snippet}
	</DataTable>
</div>

{#snippet dataTableActions(row: Row<Payment>)}
	<DropdownMenu.Root>
		<DropdownMenu.Trigger class={buttonVariants({ variant: "outline", size: "sm" })}>
			<Ellipsis class="size-4" />
		</DropdownMenu.Trigger>
		<DropdownMenu.Content>
			<DropdownMenu.Group>
				<DropdownMenu.Label>Actions</DropdownMenu.Label>
				<DropdownMenu.Separator />
				<DropdownMenu.Item>Edit</DropdownMenu.Item>
				<DropdownMenu.Item>Delete</DropdownMenu.Item>
				<DropdownMenu.Separator />
				<DropdownMenu.Item>Send Confirmation Email</DropdownMenu.Item>
			</DropdownMenu.Group>
		</DropdownMenu.Content>
	</DropdownMenu.Root>
{/snippet}
